<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />

    <link rel="stylesheet" href="./global2.css" />
    <link rel="stylesheet" href="./flipon2.css" />
    <link rel="stylesheet" href="./menu.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Autour One:wght@400&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Xtra:wght@400&display=swap"
    />

    <style>
      @font-face {
        font-family: "Greek-Freak";
        src: url("./public/Greek-Freak.ttf");
        font-weight: 400;
      }
      @font-face {
        font-family: "GemFont One";
        src: url("./public/GemFont One.ttf");
        font-weight: 400;
      }
    </style>
  </head>
  <body>
    <div class="coinflip">
      <!-- Background Music -->
      <audio id="bgMusic" loop>
        <source src="./public/music.mp3" type="audio/mpeg">
      </audio>

      <img class="bg-icon" alt="" src="./public/bg@2x.png" />

      <img class="image-103-icon" alt="" src="./public/image-103@2x.png" />

      <img
        class="soti1111-scene-of-an-ancient-g-icon"
        alt=""
        src="./public/soti1111-scene-of-an-ancient-greek-coin-flipping-in-midair-glo-ad535c06450d4988be9bab2507b82aa8-1@2x.png"
      />

      <img class="coinflip-child" alt="" src="./public/frame-13@2x.png" />

      <main class="scene">
        <img
          class="soti1111-scene-of-an-ancient-g-icon1"
          alt=""
          src="./public/soti1111-scene-of-an-ancient-greek-ornate-altar-with-greek-symb-443696c315ce43ca98fe120e80f26663-1@2x.png"
        />

        <section class="rectangle-parent">
          <footer class="frame-child"></footer>
          <div class="frame-item"></div>
        </section>
        <img
          class="coin-icon"
          loading="lazy"
          alt=""
          src="./public/coin@2x.png"
          id="mainCoin"
        />
      </main>
      <div class="layout">
        <div class="container">
          <div class="container-child"></div>
          <header class="navigation">
            <div class="buttons">
              <img
                class="back-button-icon"
                loading="lazy"
                alt=""
                src="./public/back-button@2x.png"
                onclick="history.back()"
                style="cursor: pointer;"
              />
            </div>
            <div class="title-scroll-parent">
              <img
                class="title-scroll-icon"
                alt=""
                src="./public/title-scroll@2x.png"
              />

              <a class="coin-flip">Coin Flip</a>
            </div>
            <div class="buttons">
              <img
                class="back-button-icon"
                loading="lazy"
                alt=""
                src="./public/settings-button@2x.png"
                onclick="document.getElementById('settings-panel').style.display = 'block'"
                style="cursor: pointer;"
              />
            </div>
          </header>
          <div class="status-parent">
            <div class="status">
              <div class="market-state">
                <a class="timer-90-sec" id="timer">Timer: 90 Sec</a>
              </div>
            </div>
            <div class="chart">
              <div class="ellipse-parent">
                <div class="frame-inner"></div>
                <img
                  class="frame-1-icon"
                  alt=""
                  src="./public/frame-1@2x.png"
                />

                <img
                  class="bull-icon"
                  loading="lazy"
                  alt=""
                  id="marketStateIcon"
                  src="./public/bull1@2x.png"
                />
              </div>
            </div>
            <div class="coin-balance-wrapper">
              <div class="coin-balance">
                <img class="coin-icon1" alt="" src="./public/coin-1@2x.png" />

                <div class="buttons">
                  <a class="empty" id="balanceDisplay">Loading...</a>
                </div>
              </div>
            </div>
          </div>
          <div class="coin-row">
            <div class="coin-list">
              <img
                class="coin-icon2"
                loading="lazy"
                alt=""
                src="./public/coin-2@2x.png"
              />

              <img
                class="coin-icon2"
                loading="lazy"
                alt=""
                src="./public/coin-2@2x.png"
              />

              <img
                class="coin-icon2"
                loading="lazy"
                alt=""
                src="./public/coin-2@2x.png"
              />

              <img
                class="coin-icon5"
                loading="lazy"
                alt=""
                src="./public/coin-5@2x.png"
              />

              <img
                class="coin-icon2"
                loading="lazy"
                alt=""
                src="./public/coin-2@2x.png"
              />

              <img
                class="coin-icon5"
                loading="lazy"
                alt=""
                src="./public/coin-5@2x.png"
              />

              <img
                class="coin-icon5"
                loading="lazy"
                alt=""
                src="./public/coin-8@2x.png"
              />

              <img class="coin-icon2" alt="" src="./public/coin-2@2x.png" />
            </div>
          </div>
        </div>
        <div class="content">
          <div class="image-130-parent">
            <div class="image-130"></div>
            <div class="panel">
              <div class="frame-parent">
                <div class="chat-input-wrapper">
                  <div class="chat-input">1000</div>
                </div>
                <div class="paragraph">
                  <div class="chat-message">500</div>
                  <div class="deep-content-parent">
                    <div class="deep-content">
                      <div class="chat-option">100</div>
                    </div>
                    <div class="div">0</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="visuals">
              <div class="visuals-inner">
                <div class="vector-parent">
                  <img class="vector-icon" alt="" src="./public/vector-8.svg" />

                  <img
                    class="frame-child1"
                    alt=""
                    src="./public/vector-9.svg"
                  />
                </div>
              </div>
              <img class="visuals-child" alt="" src="./public/group-8.svg" />
            </div>
            <img class="coin-icon10" alt="" src="./public/coin-10@2x.png" />
          </div>
        </div>
      </div>
      <div class="game-header">
        <div class="game-header-child"></div>
        <div class="coin-options-wrapper">
          <div class="coin-options">
            <div class="coin-amount">
              <div class="input-label">
                <h1 class="enter-bet-amount">Enter Bet Amount</h1>
              </div>
              <input 
                type="number" 
                id="betAmount" 
                class="bet-input" 
                placeholder="Enter amount"
                min="1"
              />
            </div>
            <div class="action">
              <div class="cast-buton" id="flipButton" style="opacity: 0.5; cursor: not-allowed;">
                <img class="button-icon" alt="" src="./public/button@2x.png" />
                <h1 class="flip-coin">Flip Coin</h1>
              </div>
            </div>
            <div class="stone-slab2-1-group" id="tailsOption">
              <img
                class="stone-slab2-11"
                alt=""
                src="./public/stone-slab2-11@2x.png"
              />

              <h1 class="tails">Tails</h1>
              <div class="coin-holders">
                <img
                  class="coin-icon11"
                  loading="lazy"
                  alt=""
                  src="./public/coin-11@2x.png"
                />
              </div>
              <div class="rectangle-div"></div>
            </div>
            <div class="stone-slab2-1-container" id="headsOption">
              <img
                class="stone-slab2-11"
                alt=""
                src="./public/stone-slab2-11@2x.png"
              />

              <h1 class="tails">Heads</h1>
              <div class="coin-holders">
                <img
                  class="coin-icon11"
                  loading="lazy"
                  alt=""
                  src="./public/coin-11@2x.png"
                />
              </div>
            </div>
          </div>
        </div>
        <div class="footer">
          <div class="inner-options">
            <div class="frame-group">
              <a href="./referral.html" class="shop-icon-wrapper">
                <img
                  class="shop-icon"
                  loading="lazy"
                  alt=""
                  src="./public/shop-icon@2x.png"
                />
              </a>
              <a href="./referral.html" class="referral">Referral</a>
            </div>
            <div class="frame-group">
              <a href="./quest.html" class="shop-icon-wrapper">
                <img
                  class="quest-icom-icon"
                  loading="lazy"
                  alt=""
                  src="./public/quest-icom@2x.png"
                />
              </a>
              <a href="./quest.html" class="quests1">Quests</a>
            </div>
            <div class="leaderboard">
              <a href="./leader-board.html" class="leaderboard1">Leaderboard</a>
              <a href="./leader-board.html" class="shop-icon-wrapper">
                <img
                  class="trophy-icon"
                  loading="lazy"
                  alt=""
                  src="./public/trophy-icon@2x.png"
                />
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Result Animation Container -->
      <div id="resultAnimation" class="result-animation" style="display: none;">
        <span id="resultText"></span>
      </div>

      <!-- Settings Panel -->
      <div id="settings-panel" class="settings-panel" style="display: none;">
        <div class="settings-content">
          <h3>Settings</h3>
          <div class="volume-control">
            <label for="volume">Music Volume:</label>
            <input 
              type="range" 
              id="volume" 
              min="0" 
              max="1" 
              step="0.1" 
              value="0.5"
              onchange="document.getElementById('bgMusic').volume = this.value"
            >
          </div>
          <button onclick="document.getElementById('settings-panel').style.display = 'none'">Close</button>
        </div>
      </div>
    </div>

    <script>
      // Set default username if none exists
      if (!localStorage.getItem('username')) {
        localStorage.setItem('username', 'testuser');
      }

      // Start background music when the page loads
      window.addEventListener('load', function() {
        const bgMusic = document.getElementById('bgMusic');
        bgMusic.volume = 0.5; // Set initial volume
        bgMusic.play().catch(function(error) {
          console.log("Audio autoplay failed:", error);
        });

        // Get market state from localStorage (set in diceroll2.html)
        const marketState = localStorage.getItem('marketState') || 'bull'; // Default to bull
        const marketStateIcon = document.getElementById('marketStateIcon');
        let winProbability = 0;
        let blackSwanProbability = 0;

        // Set market state icon and probabilities
        if (marketState === 'bear') {
          marketStateIcon.src = './public/bear1@2x.png';
          winProbability = 0.53;
          blackSwanProbability = 0.05;
        } else if (marketState === 'choppy') {
          marketStateIcon.src = './public/choppy@2x.png';
          winProbability = 0.60;
          blackSwanProbability = 0.10;
        } else {
          // Default to bull
          marketStateIcon.src = './public/bull1@2x.png';
          winProbability = 0.70;
          blackSwanProbability = 0.01;
        }

        // Start countdown timer
        let timeLeft = 90;
        const timerElement = document.getElementById('timer');
        
        const countdown = setInterval(() => {
          timeLeft--;
          timerElement.textContent = `Timer: ${timeLeft} Sec`;
          
          if (timeLeft <= 0) {
            clearInterval(countdown);
            timerElement.textContent = 'Time Up!';
            window.location.href = './stats.html';
          }
        }, 1000);

        // Get username and balance
        const username = localStorage.getItem('username');
        if (!username) {
          console.error('No username found');
          return;
        }

        // Get user balance from backend
        function updateBalance() {
          fetch(`/api/user/${username}`)
            .then(response => response.json())
            .then(data => {
              const balanceDisplay = document.getElementById('balanceDisplay');
              balanceDisplay.textContent = data.balance;
              validateBet(); // Revalidate bet after balance update
            })
            .catch(error => {
              console.error('Error fetching balance:', error);
            });
        }
        updateBalance();

        // Coin selection
        let selectedSide = 'heads';
        const mainCoin = document.getElementById('mainCoin');
        const headsOption = document.getElementById('headsOption');
        const tailsOption = document.getElementById('tailsOption');
        const betInput = document.getElementById('betAmount');
        const flipButton = document.getElementById('flipButton');

        headsOption.addEventListener('click', () => {
          selectedSide = 'heads';
          mainCoin.src = './public/coin@2x.png';
          headsOption.style.opacity = '1';
          tailsOption.style.opacity = '0.5';
          validateBet();
        });

        tailsOption.addEventListener('click', () => {
          selectedSide = 'tails';
          mainCoin.src = './public/tail.png';
          headsOption.style.opacity = '0.5';
          tailsOption.style.opacity = '1';
          validateBet();
        });

        // Validate bet amount
        betInput.addEventListener('input', validateBet);

        function validateBet() {
          const betAmount = parseInt(betInput.value);
          const currentBalance = parseInt(document.getElementById('balanceDisplay').textContent);
          
          if (betAmount > 0 && betAmount <= currentBalance) {
            flipButton.style.opacity = '1';
            flipButton.style.cursor = 'pointer';
          } else {
            flipButton.style.opacity = '0.5';
            flipButton.style.cursor = 'not-allowed';
          }
        }

        // Handle coin flip
        flipButton.addEventListener('click', async () => {
          const betAmount = parseInt(betInput.value);
          const currentBalance = parseInt(document.getElementById('balanceDisplay').textContent);
          
          if (betAmount <= 0 || betAmount > currentBalance || flipButton.style.cursor === 'not-allowed') {
            return;
          }

          // Disable inputs during flip
          flipButton.style.opacity = '0.5';
          flipButton.style.cursor = 'not-allowed';
          betInput.disabled = true;
          headsOption.style.pointerEvents = 'none';
          tailsOption.style.pointerEvents = 'none';

          // Add spinning animation class to main coin
          mainCoin.classList.add('coin-spin');

          // Determine outcome
          const random = Math.random();
          let outcome;
          let newBalance;

          if (random < blackSwanProbability) {
            // Black Swan Event
            outcome = 'blackswan';
            newBalance = Math.floor(currentBalance * 0.5);
          } else if (selectedSide === 'heads' && random < winProbability + blackSwanProbability) {
            // Win on heads
            outcome = 'win';
            newBalance = currentBalance + betAmount;
          } else if (selectedSide === 'tails' && random >= winProbability + blackSwanProbability) {
            // Win on tails
            outcome = 'win';
            newBalance = currentBalance + betAmount;
          } else {
            // Loss
            outcome = 'lose';
            newBalance = currentBalance - betAmount;
          }

          // Update balance in backend
          try {
            await fetch('/api/user/update-balance', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                username,
                balance: newBalance
              })
            });

            // Show result animation after coin spin
            setTimeout(() => {
              // Remove spinning animation
              mainCoin.classList.remove('coin-spin');

              // Show final coin state
              mainCoin.src = selectedSide === 'heads' ? './public/coin@2x.png' : './public/tail.png';

              // Show result animation
              const resultAnimation = document.getElementById('resultAnimation');
              const resultText = document.getElementById('resultText');
              
              if (outcome === 'blackswan') {
                resultText.textContent = `BLACK SWAN! -${currentBalance - newBalance}`;
                resultText.style.color = '#ff0000';
              } else if (outcome === 'win') {
                resultText.textContent = `+${betAmount}`;
                resultText.style.color = '#00ff00';
              } else {
                resultText.textContent = `-${betAmount}`;
                resultText.style.color = '#ff0000';
              }

              resultAnimation.style.display = 'block';

              // Hide result and re-enable inputs after animation
              setTimeout(() => {
                resultAnimation.style.display = 'none';
                
                // Re-enable inputs
                flipButton.style.opacity = '1';
                flipButton.style.cursor = 'pointer';
                betInput.disabled = false;
                headsOption.style.pointerEvents = 'auto';
                tailsOption.style.pointerEvents = 'auto';
                
                // Update displayed balance
                updateBalance();
                
                // Clear bet amount
                betInput.value = '';
                validateBet();
              }, 2000);
            }, 1000);
          } catch (error) {
            console.error('Error updating balance:', error);
            // Re-enable inputs on error
            flipButton.style.opacity = '1';
            flipButton.style.cursor = 'pointer';
            betInput.disabled = false;
            headsOption.style.pointerEvents = 'auto';
            tailsOption.style.pointerEvents = 'auto';
          }
        });
      });
    </script>
  </body>
</html>
